<!DOCTYPE html>
<html>

<head>
    <title>TwitterClone</title>
</head>

<body>
<h1>TwitterClone</h1>

<div id="userlogin">  
<h2>Login</h2>
<input type="text"  placeholder="username" name="userid" id="userid" /> 
<br/>    
<br/>     
<input type="password"  placeholder="password" name="password" id="password" />
<br/>    
<br/>     
<input type="button" id="loginbutton" name="loginbutton"  value="Login" onclick="handleUser(event);"  onkeypress="if(event.keyCode === 13){handleUser(event);}" />
<br/>    
<br/>   
</div>
 
<div id="feeds" style="display:none;"><h3>Userfeeds:</h3><br/></div>

<script>
 var userInfo;
 function handleUser(evt) {   
        console.log('handleUser');
        evt.preventDefault();           
        userInfo = document.getElementById("userid").value;   
        console.log('userInfo' + userInfo);  
        document.getElementById("userlogin").style.display = 'none';
        document.getElementById("feeds").style.display = '';
        getUserFeeds(userInfo);
 };
 function callAjax(inputData) {
    
        //alert('callAjax inputData: ' + inputData);
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState === 4 && this.status === 200) {
               // alert("this.responseText :" + this.responseText );
                var data = JSON.parse(this.responseText);                              
                document.getElementById("testDemo").innerHTML = this.responseText;
            }
        };
        xhttp.open("GET", "http://www.omdbapi.com/?t="+inputData+ "&y=&plot=short&r=json", true);    
        xhttp.send();
        document.getElementById("testDemo").innerHTML = "waiting for response..."; 
  
    }      
function getUserFeeds(userId) {
  var xhttp = new XMLHttpRequest(userId);
  var feedUrl= "http://localhost:8080/getUserFeeds/" + userId + "/";
  
  console.log(feedUrl);
  console.log(xhttp.responseText);
  
  xhttp.onreadystatechange = function() {
    if (xhttp.readyState === 4 && xhttp.status === 200) {     
 
	 var obj = JSON.parse(xhttp.responseText);	  
	 for (var i = 0; i < obj.length; i++) { 		  
			// console.log(i + " -> " + obj[i]['tweetText']);	
			var cp =  document.createElement('span');            
            var userTweethref='http://localhost:8080/getUserTweets/' + obj[i]['authorID']  + '/';    
            console.log("userTweethref  -> " + userTweethref);            
            cp.innerHTML = '<a id="userTweets" onclick="window.open(\'' + userTweethref + '\', \'pop\', \'width=600,height=400\');"><u>' +  obj[i]['UserName'] + '</u></a>' + 
            '&nbsp;&nbsp;&nbsp;' + obj[i]['lastupdated'] + '<br/>' + obj[i]['tweetText'] + '<br/>' +
            '<button id="replyBtn' +  obj[i]['tweetID'] + '" onclick="getReplies(' + obj[i]['tweetID'] + ')">Replies</button><br/><div id="replies' +  obj[i]['tweetID'] + '""></div><br/>';
 			document.getElementById("feeds").appendChild(cp);		
	  } 
	}
/*
   var obj = JSON.parse(xhttp.responseText);    
   for (var i = 0; i < obj.length; i++) {       
      // console.log(i + " -> " + obj[i]['tweetText']); 
      var cp =  document.createElement('span');
            cp.innerHTML = '<a href="http://localhost:8080/getUserFeeds/" + userId + "/">' +  obj[i]['UserName'] + '</a>' + 
            '&nbsp;&nbsp;&nbsp;' + obj[i]['lastupdated'] + '<br/>' + obj[i]['tweetText'] + '<br/>' +
            '<button id="replyBtn' +  obj[i]['tweetID'] + '" onclick="getReplies(' + obj[i]['tweetID'] + ')">Replies</button><br/><div id="replies' +  obj[i]['tweetID'] + '""></div><br/>';
      document.getElementById("feeds").appendChild(cp); 
      
    } 
  }
*/
  };
  xhttp.open("GET", feedUrl, true);
  xhttp.send();
}


function getReplies(tweetID) {
  var xhttp = new XMLHttpRequest(tweetID);
  var repliesURL= "http://localhost:8080/getReplies/" + tweetID + "/";

  console.log("replies url " + repliesURL);
  console.log("response  " + xhttp.responseText);

  xhttp.onreadystatechange = function() {
    if (xhttp.readyState === 4 && xhttp.status === 200) {     
     var obj = JSON.parse(xhttp.responseText);
     if(obj.length === 0 ) document.getElementById("replyBtn" + tweetID).style.display = "none";;   
     for (var i = 0; i < obj.length; i++) {       
      var cp =  document.createElement('span');
      cp.innerHTML = obj[i]['LastUpdated'] + '&nbsp;&nbsp;&nbsp;' + obj[i]['ReplyText'] + '<br/>';
      //console.log("reply span " + replySpan);
      document.getElementById("replies" + tweetID).appendChild(cp); 
    }
    } 
    areRepliesHidden(tweetID);
  };

  function areRepliesHidden(tweetID){
    var replies = document.getElementById("replies" + tweetID);

    if(replies.style.display == "block"){
      replies.style.display = "none";
      replies.innerHTML = "";
    }
    else{
      document.getElementById("replies" + tweetID).style.display = "block";
    }
  }

  xhttp.open("GET", repliesURL, true);
  xhttp.send();

        //document.getElementById("replies").innerHTML = replySpan;
      //document.getElementById("replies").style.display = "block";
}

</script>
</body>
</html>